<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ibn Sina - Plateforme de Gestion des Groupes</title>
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Modern Auth Screen Styles */
    .modern-auth-container {
      min-height: 100vh;
      display: flex;
      background: var(--bg-);
    }

    /* Left Panel - Branding */
    .auth-branding {
      flex: 1;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 3rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .auth-branding::before {
      content: '';
      position: absolute;
      width: 500px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      top: -250px;
      right: -250px;
    }

    .auth-branding::after {
      content: '';
      position: absolute;
      width: 300px;
      height: 300px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      bottom: -150px;
      left: -150px;
    }

    .brand-content {
      position: relative;
      z-index: 1;
      text-align: center;
      max-width: 500px;
    }

    .brand-logo {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      font-weight: 800;
      margin: 0 auto 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    .brand-content h1 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 1rem;
      text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
    }

    .brand-content p {
      font-size: 1.2rem;
      opacity: 0.9;
      line-height: 1.6;
    }

    .brand-features {
      margin-top: 3rem;
      display: grid;
      gap: 1.5rem;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 1rem 1.5rem;
      border-radius: 15px;
      transition: all 0.3s;
    }

    .feature-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(10px);
    }

    .feature-icon {
      font-size: 2rem;
    }

    .feature-text {
      text-align: left;
    }

    .feature-text strong {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .feature-text span {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* Right Panel - Auth Form */
    .auth-panel {
      flex: 1;
      padding: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
    }

    .auth-form-container {
      width: 100%;
      max-width: 460px;
    }

    .auth-form-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .auth-form-header h2 {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 0.5rem;
    }

    .auth-form-header p {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .modern-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      padding: 0.5rem;
      background: var(--bg-alt);
      border-radius: var(--rad-md);
    }

    .modern-tab {
      flex: 1;
      padding: 0.875rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 1rem;
      border-radius: var(--rad-sm);
      cursor: pointer;
      transition: all 0.3s;
    }

    .modern-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .modern-tab.active {
      background: var(--bg-card);
    }

    .form-container {
      display: none;
    }

    .form-container.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-group label {
      display: block;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon input,
    .input-with-icon select {
      padding-left: 3rem;
    }

    .input-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .submit-btn {
      width: 100%;
      padding: 1rem;
      font-size: 1.05rem;
      font-weight: 700;
      margin-top: 1rem;
    }

    .success-screen {
      text-align: center;
      padding: 2rem;
    }

    .success-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--success), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
      font-size: 3rem;
      animation: scaleIn 0.5s ease-out;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
      }

      to {
        transform: scale(1);
      }
    }

    /* Responsive */
    @media (max-width: 968px) {
      .modern-auth-container {
        flex-direction: column;
      }

      .auth-branding {
        min-height: 40vh;
        padding: 2rem;
      }

      .brand-logo {
        width: 80px;
        height: 80px;
        font-size: 2.5rem;
      }

      .brand-content h1 {
        font-size: 2rem;
      }

      .brand-features {
        display: none;
      }

      .auth-panel {
        padding: 2rem 1.5rem;
      }
    }

    /* Theme Toggle Button */
    .theme-toggle-btn {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all 0.3s;
      z-index: 1000;
      box-shadow: var(--shadow-md);
    }

    .theme-toggle-btn:hover {
      transform: rotate(30deg) scale(1.1);
    }

    /* Forgot Password Link */
    .forgot-password-link {
      display: block;
      text-align: center;
      margin-top: 1rem;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .forgot-password-link:hover {
      text-decoration: underline;
      color: var(--primary-dark, #4f46e5);
    }

    /* Reset Password Modal */
    .reset-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .reset-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .reset-modal-content {
      background: var(--bg-card);
      padding: 2.5rem;
      border-radius: var(--rad-lg);
      max-width: 450px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .reset-modal-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .reset-modal-header h3 {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 0.5rem;
    }

    .reset-modal-header p {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-actions button {
      flex: 1;
    }
  </style>
</head>

<body>
  <!-- Theme Toggle -->
  <button class="theme-toggle-btn" onclick="toggleTheme()" title="Changer le th√®me">
    üåì
  </button>

  <div class="modern-auth-container">
    <!-- Left Branding Panel -->
    <div class="auth-branding">
      <div class="brand-content">
        <div class="brand-logo">IS</div>
        <h1>Ibn Sina</h1>
        <p>Plateforme de Gestion des Groupes WhatsApp pour √©tudiants et laur√©ats</p>

        <div class="brand-features">
          <div class="feature-item">
            <div class="feature-icon">üìö</div>
            <div class="feature-text">
              <strong>Gestion des Fili√®res</strong>
              <span>Acc√©dez √† tous vos groupes WhatsApp</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üéì</div>
            <div class="feature-text">
              <strong>R√©seau Alumni</strong>
              <span>Connectez-vous avec les laur√©ats</span>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">üìÖ</div>
            <div class="feature-text">
              <strong>√âv√©nements</strong>
              <span>Restez inform√© des actualit√©s</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Auth Panel -->
    <div class="auth-panel">
      <div class="auth-form-container">
        <div class="auth-form-header">
          <h2 id="form-title">Bienvenue !</h2>
          <p id="form-subtitle">Connectez-vous pour acc√©der √† votre espace</p>
        </div>

        <!-- Modern Tabs -->
        <div class="modern-tabs">
          <button class="modern-tab active" onclick="switchModernTab('login')">Connexion</button>
          <button class="modern-tab" onclick="switchModernTab('signup')">Inscription</button>
        </div>

        <!-- Messages -->
        <div id="auth-message" class="hidden" style="margin-bottom: 1.5rem;"></div>

        <!-- Login Form -->
        <div id="login-container" class="form-container active">
          <form id="login-form">
            <div class="input-group">
              <label for="login-email">Email</label>
              <div class="input-with-icon">
                <span class="input-icon">üìß</span>
                <input type="email" id="login-email" class="form-input" placeholder="votre.email@example.com" required>
              </div>
            </div>

            <div class="input-group">
              <label for="login-password">Mot de passe</label>
              <div class="input-with-icon">
                <span class="input-icon">üîí</span>
                <input type="password" id="login-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
              </div>
            </div>

            <button type="submit" class="btn btn-primary submit-btn">
              <span id="login-btn-text">Se connecter</span>
              <span id="login-loading" class="loading-small hidden"></span>
            </button>

            <a href="#" class="forgot-password-link" onclick="openResetModal(); return false;">
              üîë Mot de passe oubli√© ?
            </a>
          </form>
        </div>

        <!-- Signup Form -->
        <div id="signup-container" class="form-container">
          <form id="signup-form">
            <div class="input-group">
              <label for="signup-name">Nom complet</label>
              <div class="input-with-icon">
                <span class="input-icon">üë§</span>
                <input type="text" id="signup-name" class="form-input" placeholder="Pr√©nom Nom" required>
              </div>
            </div>

            <div class="input-group">
              <label for="signup-phone">T√©l√©phone</label>
              <div class="input-with-icon">
                <span class="input-icon">üì±</span>
                <input type="tel" id="signup-phone" class="form-input" placeholder="+212 6XX XXX XXX" required>
              </div>
            </div>

            <div class="input-group">
              <label for="signup-niveau">Niveau / Statut</label>
              <div class="input-with-icon">
                <span class="input-icon">üéì</span>
                <select id="signup-niveau" class="form-select" required onchange="togglePromoField(this.value)">
                  <option value="">-- S√©lectionnez --</option>
                  <option value="TC">Tronc Commun (TC)</option>
                  <option value="1BAC">1√®re Ann√©e Bac (1BAC)</option>
                  <option value="2BAC">2√®me Ann√©e Bac (2BAC)</option>
                  <option value="Laur√©at">Laur√©at (Dipl√¥m√©)</option>
                </select>
              </div>
            </div>

            <div class="input-group">
              <label for="signup-filiere">Fili√®re</label>
              <div class="input-with-icon">
                <span class="input-icon">üìö</span>
                <select id="signup-filiere" class="form-select" required>
                  <option value="">-- S√©lectionnez --</option>
                  <option value="STE">STE - Sciences et Technologies √âlectriques</option>
                  <option value="STM">STM - Sciences et Technologies M√©caniques</option>
                  <option value="AA">AA - Arts Appliqu√©s</option>
                  <option value="ECO">ECO - √âconomie</option>
                  <option value="BTS">BTS - Brevet de Technicien Sup√©rieur</option>
                </select>
              </div>
            </div>

            <div id="promo-group" class="input-group hidden">
              <label for="signup-promo">Ann√©e de Promotion</label>
              <div class="input-with-icon">
                <span class="input-icon">üìÖ</span>
                <input type="number" id="signup-promo" class="form-input" placeholder="2024" min="1990" max="2030">
              </div>
            </div>

            <div class="input-group">
              <label for="signup-email">Email</label>
              <div class="input-with-icon">
                <span class="input-icon">üìß</span>
                <input type="email" id="signup-email" class="form-input" placeholder="votre.email@example.com" required>
              </div>
            </div>

            <div class="input-group">
              <label for="signup-password">Mot de passe</label>
              <div class="input-with-icon">
                <span class="input-icon">üîí</span>
                <input type="password" id="signup-password" class="form-input" placeholder="Minimum 6 caract√®res"
                  required minlength="6">
              </div>
            </div>

            <div class="input-group">
              <label for="signup-confirm">Confirmer le mot de passe</label>
              <div class="input-with-icon">
                <span class="input-icon">üîí</span>
                <input type="password" id="signup-confirm" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
              </div>
            </div>

            <button type="submit" class="btn btn-primary submit-btn">
              <span id="signup-btn-text">S'inscrire</span>
              <span id="signup-loading" class="loading-small hidden"></span>
            </button>
          </form>
        </div>

        <!-- Success Screen -->
        <div id="signup-success" class="success-screen hidden">
          <div class="success-icon">‚úì</div>
          <h3 style="font-weight: 700; margin-bottom: 1rem; color: var(--success); font-size: 1.6rem;">
            Inscription r√©ussie !
          </h3>
          <p id="success-msg-content" style="color: var(--text-muted); line-height: 1.6; margin-bottom: 2rem;">
            <!-- Message dynamique -->
          </p>

          <div
            style="background: var(--bg-alt); border-left: 4px solid var(--warning); padding: 1.25rem; border-radius: var(--rad-md); margin-bottom: 2rem; text-align: left;">
            <strong style="display: block; margin-bottom: 0.5rem; color: var(--warning);">‚ö†Ô∏è V√©rifiez vos spams
              !</strong>
            Si vous ne trouvez pas l'email, consultez votre dossier <strong>Courrier ind√©sirable</strong>.
          </div>

          <button class="btn btn-secondary" onclick="location.reload()" style="width: 100%;">
            Retour √† la connexion
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div id="reset-modal" class="reset-modal">
    <div class="reset-modal-content">
      <div class="reset-modal-header">
        <h3>üîê R√©initialiser le mot de passe</h3>
        <p>Entrez votre adresse email pour recevoir un lien de r√©initialisation</p>
      </div>

      <div id="reset-message" class="hidden" style="margin-bottom: 1.5rem;"></div>

      <form id="reset-form">
        <div class="input-group">
          <label for="reset-email">Email</label>
          <div class="input-with-icon">
            <span class="input-icon">üìß</span>
            <input type="email" id="reset-email" class="form-input" placeholder="votre.email@example.com" required>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeResetModal()">
            Annuler
          </button>
          <button type="submit" class="btn btn-primary">
            <span id="reset-btn-text">Envoyer</span>
            <span id="reset-loading" class="loading-small hidden"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // Theme toggle
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    // Init theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Reset password modal functions
    function openResetModal() {
      document.getElementById('reset-modal').classList.add('active');
      document.getElementById('reset-email').value = '';
      document.getElementById('reset-message').classList.add('hidden');
    }

    function closeResetModal() {
      document.getElementById('reset-modal').classList.remove('active');
    }

    // Close modal on outside click
    document.getElementById('reset-modal').addEventListener('click', (e) => {
      if (e.target.id === 'reset-modal') {
        closeResetModal();
      }
    });

    // Reset password form handler
    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('reset-email').value;

      document.getElementById('reset-btn-text').classList.add('hidden');
      document.getElementById('reset-loading').classList.remove('hidden');

      const result = await resetPassword(email);

      document.getElementById('reset-btn-text').classList.remove('hidden');
      document.getElementById('reset-loading').classList.add('hidden');

      if (result.success) {
        showSuccess('reset-message', result.message);
        setTimeout(() => {
          closeResetModal();
        }, 3000);
      } else {
        showError('reset-message', formatFirebaseError(result.error));
      }
    });

    // Switch tabs
    function switchModernTab(tab) {
      const loginTab = document.querySelector('.modern-tab:first-child');
      const signupTab = document.querySelector('.modern-tab:last-child');
      const loginContainer = document.getElementById('login-container');
      const signupContainer = document.getElementById('signup-container');
      const formTitle = document.getElementById('form-title');
      const formSubtitle = document.getElementById('form-subtitle');

      document.getElementById('auth-message').classList.add('hidden');

      if (tab === 'login') {
        loginTab.classList.add('active');
        signupTab.classList.remove('active');
        loginContainer.classList.add('active');
        signupContainer.classList.remove('active');
        formTitle.textContent = 'Bienvenue !';
        formSubtitle.textContent = 'Connectez-vous pour acc√©der √† votre espace';
      } else {
        signupTab.classList.add('active');
        loginTab.classList.remove('active');
        signupContainer.classList.add('active');
        loginContainer.classList.remove('active');
        formTitle.textContent = 'Cr√©er un compte';
        formSubtitle.textContent = 'Rejoignez la communaut√© Ibn Sina';
      }
    }

    // Toggle promo field
    function togglePromoField(val) {
      const promoGroup = document.getElementById('promo-group');
      if (val === 'Laur√©at') {
        promoGroup.classList.remove('hidden');
        document.getElementById('signup-promo').required = true;
      } else {
        promoGroup.classList.add('hidden');
        document.getElementById('signup-promo').required = false;
      }
    }

    // Auth state
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const profile = await getCurrentUserProfile();
        if (profile) {
          if (profile.role === 'alumni' && !profile.isApproved) {
            await auth.signOut();
            showError('auth-message', 'Votre compte Laur√©at est en attente d\'approbation.');
            return;
          }
          redirectByRole(profile.role);
        }
      }
    });

    // URL error handling
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      if (error === 'unverified') {
        showError('auth-message', 'Votre email n\'est pas encore v√©rifi√©. Consultez vos spams.');
      } else if (error === 'suspended') {
        showError('auth-message', 'Votre compte a √©t√© suspendu.');
      } else if (error === 'unapproved') {
        showError('auth-message', 'Votre compte est en attente d\'approbation.');
      }
    });

    // Login form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      document.getElementById('login-btn-text').classList.add('hidden');
      document.getElementById('login-loading').classList.remove('hidden');

      const result = await login(email, password);

      document.getElementById('login-btn-text').classList.remove('hidden');
      document.getElementById('login-loading').classList.add('hidden');

      if (result.success) {
        showSuccess('auth-message', 'Connexion r√©ussie ! Redirection...');
        const profile = await getCurrentUserProfile();
        if (profile) {
          if (!profile.isApproved) {
            showError('auth-message', 'Votre compte est en attente de validation par l\'administration ou votre d√©l√©gu√©.');
            await auth.signOut();
            return;
          }
          setTimeout(() => redirectByRole(profile.role), 1000);
        }
      } else {
        if (result.error === 'email-not-verified') {
          showError('auth-message', result.message);
        } else {
          showError('auth-message', formatFirebaseError(result.error));
        }
      }
    });

    // Signup form
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('signup-name').value;
      const phone = document.getElementById('signup-phone').value;
      const niveau = document.getElementById('signup-niveau').value;
      const promo = document.getElementById('signup-promo').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const confirm = document.getElementById('signup-confirm').value;
      const filiere = document.getElementById('signup-filiere').value;

      if (password !== confirm) {
        showError('auth-message', 'Les mots de passe ne correspondent pas.');
        return;
      }

      document.getElementById('signup-btn-text').classList.add('hidden');
      document.getElementById('signup-loading').classList.remove('hidden');

      const result = await signup(email, password, name, phone, 'student', niveau, promo, filiere);

      document.getElementById('signup-btn-text').classList.remove('hidden');
      document.getElementById('signup-loading').classList.add('hidden');

      if (result.success) {
        document.querySelector('.modern-tabs').classList.add('hidden');
        document.getElementById('signup-container').classList.remove('active');
        document.getElementById('auth-message').classList.add('hidden');

        let msg = 'Un email de v√©rification a √©t√© envoy√© √† votre adresse.';
        if (niveau === 'Laur√©at') {
          msg += " En tant que Laur√©at, votre acc√®s sera activ√© apr√®s validation par l'administrateur.";
        }

        document.getElementById('success-msg-content').textContent = msg;
        document.getElementById('signup-success').classList.remove('hidden');
      } else {
        showError('auth-message', formatFirebaseError(result.error));
      }
    });
  </script>
  <script src="js/dev-switcher.js"></script>
</body>

</html>