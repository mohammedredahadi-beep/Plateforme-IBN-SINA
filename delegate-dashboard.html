<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard D√©l√©gu√© - Ibn Sina</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <div class="logo-icon">IS</div>
                    <span>Espace D√©l√©gu√©</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <button class="sidebar-link active" data-tab="home">
                    üè† <span class="nav-label">Accueil</span>
                </button>
                <button class="sidebar-link" data-tab="whatsapp">
                    üìã <span class="nav-label">Groupe WhatsApp</span>
                </button>
                <button class="sidebar-link" data-tab="validations">
                    üõ°Ô∏è <span class="nav-label">Validations</span>
                    <span id="sidebar-badge-validations" class="badge badge-error hidden">0</span>
                </button>
                <button class="sidebar-link" data-tab="my-class">
                    üë• <span class="nav-label">Ma Classe</span>
                </button>
                <button class="sidebar-link" data-tab="announcements">
                    üì¢ <span class="nav-label">Annonces</span>
                </button>
                <button class="sidebar-link" data-tab="settings">
                    ‚öôÔ∏è <span class="nav-label">Param√®tres</span>
                </button>
                <button class="sidebar-link" data-tab="notifications">
                    üîî <span class="nav-label">Notifications</span>
                    <span id="sidebar-badge-notif" class="badge badge-warning hidden">0</span>
                </button>
            </nav>

            <div style="margin-top: auto; padding: 1rem 0; border-top: 1px solid var(--border);">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <div
                            style="width: 38px; height: 38px; background: var(--bg-alt); border-radius: var(--rad-full); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary);">
                            D
                        </div>
                        <div>
                            <div id="user-name" style="font-size: 0.9rem; font-weight: 600;">Chargement...</div>
                            <div id="delegate-filiere" style="font-size: 0.75rem; color: var(--text-dim);">Chargement...
                            </div>
                        </div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Changer le th√®me"
                        style="padding: 5px; border-radius: 5px; background: var(--bg-alt); border: none; cursor: pointer;">üåì</button>
                </div>
                <button class="btn btn-secondary w-full" onclick="logout()">D√©connexion</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="flex justify-between items-center mb-2 reveal-anim">
                <div>
                    <h1
                        style="font-size: 2.5rem; font-weight: 800; letter-spacing: -0.04em; background: var(--grad-premium); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        Gestion Fili√®re</h1>
                    <p id="current-view-subtitle" style="color: var(--text-muted); font-weight: 500;">G√©rez les acc√®s
                        WhatsApp pour votre classe</p>
                </div>
                <div id="delegate-message" class="hidden"></div>
            </header>

            <!-- Home / Overview View -->
            <div id="home-view" class="tab-view">
                <div class="grid grid-3 mb-2 reveal-anim">
                    <div class="card premium-card glass-premium" style="border-left: 4px solid var(--primary);">
                        <div class="flex items-center gap-2 mb-1">
                            <span style="font-size: 1.5rem;">üõ°Ô∏è</span>
                            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">En
                                attente</span>
                        </div>
                        <div id="stat-pending" style="font-size: 2rem; font-weight: 800; color: var(--text-main);">0
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">Inscriptions √† valider
                        </div>
                    </div>

                    <div class="card premium-card glass-premium" style="border-left: 4px solid var(--secondary);">
                        <div class="flex items-center gap-2 mb-1">
                            <span style="font-size: 1.5rem;">üë•</span>
                            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">Ma
                                Classe</span>
                        </div>
                        <div id="stat-total" style="font-size: 2rem; font-weight: 800; color: var(--text-main);">0</div>
                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">√âtudiants membres</div>
                    </div>

                    <div class="card premium-card glass-premium" style="border-left: 4px solid var(--accent);">
                        <div class="flex items-center gap-2 mb-1">
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                            <span
                                style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">Approuv√©s</span>
                        </div>
                        <div id="stat-approved" style="font-size: 2rem; font-weight: 800; color: var(--text-main);">0
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">Depuis le d√©but</div>
                    </div>
                </div>

                <div class="grid grid-2 gap-2 reveal-anim" style="animation-delay: 0.1s;">
                    <!-- Recent Announcements Preview -->
                    <div class="card glass-premium">
                        <div class="flex justify-between items-center mb-1">
                            <h3 style="font-weight: 700; font-size: 1.1rem;">üì¢ Annonces R√©centes</h3>
                            <button class="btn btn-secondary btn-sm" onclick="switchTab('announcements')">Voir
                                tout</button>
                        </div>
                        <div id="recent-announcements-list" style="margin-top: 1rem;">
                            <p style="color: var(--text-dim); font-size: 0.9rem; text-align: center;">Chargement...</p>
                        </div>
                    </div>

                    <!-- Setup Quick Action -->
                    <div class="card glass-premium flex flex-col justify-center items-center text-center p-2">
                        <div
                            style="width: 60px; height: 60px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                            <span style="font-size: 1.8rem;">üîó</span>
                        </div>
                        <h3 style="font-weight: 700; margin-bottom: 0.5rem;">Groupe WhatsApp</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Assurez-vous que le lien d'invitation est √† jour pour vos nouveaux camarades.
                        </p>
                        <button class="btn btn-primary" onclick="switchTab('whatsapp')"
                            style="width: 100%; border: none; background: var(--grad-premium);">
                            Configurer le lien
                        </button>
                    </div>
                </div>
            </div>

            <!-- WhatsApp View -->
            <div id="whatsapp-view" class="tab-view" style="display: none;">
                <div class="card glass-premium mb-2">
                    <h3 style="font-weight: 600; margin-bottom: var(--spacing-xs);">üí¨ Lien du Groupe WhatsApp</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Configurez le lien WhatsApp de votre classe. Les √©tudiants valid√©s y auront acc√®s
                        automatiquement.
                    </p>
                </div>
                <!-- ... remains same ... -->

                <div class="card premium-card glass-premium reveal-on-scroll">
                    <form id="whatsapp-link-form" onsubmit="updateFiliereSettings(event)">
                        <div class="form-group">
                            <label class="form-label" for="setting-whatsapp">Lien du groupe WhatsApp *</label>
                            <input type="url" id="setting-whatsapp" class="form-input"
                                placeholder="https://chat.whatsapp.com/..." required
                                style="background: var(--glass-bg);">
                            <small style="color: var(--text-secondary); font-size: 0.85rem;">
                                Ce lien sera affich√© automatiquement aux √©tudiants valid√©s de votre fili√®re.
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary hover-scale"
                            style="width: 100%; height: 45px; border: none; background: var(--grad-premium);">
                            üíæ Enregistrer le lien
                        </button>
                    </form>
                </div>

                <div class="card" style="margin-top: var(--spacing-lg);">
                    <h4 style="font-weight: 600; margin-bottom: var(--spacing-sm);">‚ÑπÔ∏è Information</h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                        Les √©tudiants n'ont plus besoin de faire de demande. Une fois que vous validez leur compte dans
                        l'onglet
                        <strong>Validations</strong>, ils voient automatiquement le lien WhatsApp que vous avez
                        configur√© ici.
                    </p>
                </div>
            </div>

            <!-- Validations View -->
            <div id="validations-view" class="tab-view" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <h3 style="font-weight: 600; margin-bottom: var(--spacing-xs);">üõ°Ô∏è Validation des Inscriptions</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Validez les √©tudiants de votre fili√®re pour qu'ils puissent acc√©der √† la plateforme.
                    </p>
                </div>

                <div id="validation-list" class="grid grid-2">
                    <div class="card text-center">
                        <p style="color: var(--text-secondary);">Chargement des inscriptions en attente...</p>
                    </div>
                </div>
            </div>

            <!-- My Class View -->
            <div id="my-class-view" class="tab-view" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <h3 style="font-weight: 600; margin-bottom: var(--spacing-xs);">üë• Ma Classe</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Liste des √©tudiants de votre fili√®re
                    </p>
                </div>

                <div id="class-list" class="grid grid-2">
                    <div class="card text-center">
                        <p style="color: var(--text-secondary);">Chargement de la liste...</p>
                    </div>
                </div>
            </div>

            <!-- Announcements View -->
            <div id="announcements-view" class="tab-view" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <h3 style="font-weight: 600;">üì¢ Gestion des Annonces</h3>
                    <p style="color: var(--text-secondary);">Publiez des informations pour votre fili√®re</p>
                </div>

                <!-- Formulaire de cr√©ation -->
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">Nouvelle annonce</h4>
                    <form id="create-announcement-form" onsubmit="handleCreateAnnouncement(event)">
                        <div class="form-group">
                            <label class="form-label">Titre</label>
                            <input type="text" id="announce-title" class="form-input" required
                                placeholder="Ex: Changement de salle...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contenu</label>
                            <textarea id="announce-content" class="form-input" rows="3" required
                                placeholder="Votre message..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select id="announce-type" class="form-input">
                                <option value="Info">Information</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Warning">Important</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Publier l'annonce</button>
                    </form>
                </div>

                <!-- Historique -->
                <div>
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">Vos derni√®res annonces</h4>
                    <div id="my-announcements-list">
                        <div class="card text-center">
                            <p style="color: var(--text-secondary);">Chargement de l'historique...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="tab-view" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <h3 style="font-weight: 600;">‚öôÔ∏è Param√®tres de la fili√®re</h3>
                    <p style="color: var(--text-secondary);">Configurez votre espace d√©l√©gu√©</p>
                </div>

                <div class="card">
                    <form id="settings-form" onsubmit="updateFiliereSettings(event)">
                        <div class="form-group">
                            <label class="form-label" for="setting-whatsapp-2">Lien du groupe WhatsApp *</label>
                            <input type="url" id="setting-whatsapp-2" class="form-input"
                                placeholder="https://chat.whatsapp.com/..." required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            üíæ Enregistrer
                        </button>
                    </form>
                </div>
            </div>

            <!-- Notifications View -->
            <div id="notifications-view" class="tab-view" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-md);">
                    <h3 style="font-weight: 600;">üîî Notifications</h3>
                    <p style="color: var(--text-secondary);">Vos messages et alertes</p>
                </div>

                <div id="notifications-feed">
                    <div class="card text-center">
                        <p style="color: var(--text-secondary);">Chargement...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Scripts personnalis√©s -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui-core.js"></script>
    <script src="js/validations.js"></script>
    <script src="js/delegate.js"></script>
    <script src="js/announcements.js"></script>
    <script src="js/notifications.js?v=1.1"></script>
    <script src="js/premium-ui.js"></script>

    <script>
        // Theme toggle
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Init theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Simple tab navigation system
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);

            // Hide all views
            document.querySelectorAll('.tab-view').forEach(view => {
                view.style.display = 'none';
            });

            // Remove active class from all buttons
            document.querySelectorAll('.sidebar-link').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected view
            const targetView = document.getElementById(tabName + '-view');
            if (targetView) {
                targetView.style.display = 'block';
                console.log('Showing view:', tabName + '-view');
            } else {
                console.error('View not found:', tabName + '-view');
            }

            // Add active class to clicked button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // Update subtitle
            const subtitles = {
                'home': 'Ma Classe en un coup d\'≈ìil',
                'whatsapp': 'G√©rez les acc√®s WhatsApp pour votre classe',
                'validations': 'Validez les nouveaux √©tudiants',
                'announcements': 'Communiquez avec votre classe',
                'my-class': 'Liste des √©tudiants de votre fili√®re',
                'settings': 'Configurez votre espace',
                'notifications': 'Vos alertes et messages'
            };
            document.getElementById('current-view-subtitle').textContent = subtitles[tabName] || '';

            // Load view data
            if (tabName === 'home') {
                if (typeof loadDashboardOverview === 'function') {
                    loadDashboardOverview();
                }
            } else if (tabName === 'validations') {
                if (typeof displayDelegateValidations === 'function') {
                    displayDelegateValidations();
                }
            } else if (tabName === 'whatsapp' || tabName === 'settings') {
                if (typeof loadSettings === 'function') {
                    loadSettings();
                }
            } else if (tabName === 'announcements') {
                if (typeof loadDelegateHistory === 'function') {
                    loadDelegateHistory();
                }
            } else if (tabName === 'notifications') {
                if (typeof initNotificationsView === 'function') {
                    initNotificationsView();
                }
            } else if (tabName === 'my-class') {
                if (typeof loadMyClass === 'function') {
                    loadMyClass();
                }
            }
        }

        // Attach click handlers to sidebar buttons
        document.querySelectorAll('.sidebar-link[data-tab]').forEach(btn => {
            btn.addEventListener('click', function () {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', async function () {
            await initDelegateDashboard();
            // Show default tab
            switchTab('home');
        });
    </script>

    <script src="js/dev-switcher.js"></script>
</body>

</html>